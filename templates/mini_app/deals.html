{% extends "mini_app/base.html" %}

{% block title %}–ú–æ–∏ —Å–¥–µ–ª–∫–∏ - NFT Gifts Market{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 16px;">üìã –ú–æ–∏ —Å–¥–µ–ª–∫–∏</h2>
    
    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
        <button class="btn" id="sellerTab" onclick="showTab('seller')" style="flex: 1;">
            üíº –ü—Ä–æ–¥–∞–∂–∏
        </button>
        <button class="btn btn-secondary" id="buyerTab" onclick="showTab('buyer')" style="flex: 1;">
            üõí –ü–æ–∫—É–ø–∫–∏
        </button>
    </div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ –ø—Ä–æ–¥–∞–∂ -->
<div id="sellerDeals">
    <div class="card">
        <h3 style="margin-bottom: 12px;">üíº –ú–æ–∏ –ø—Ä–æ–¥–∞–∂–∏</h3>
        <div id="sellerDealsList">
            <div class="text-center" style="padding: 20px; color: var(--tg-theme-hint-color);">
                ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–¥–µ–ª–æ–∫...
            </div>
        </div>
    </div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ–∫—É–ø–æ–∫ -->
<div id="buyerDeals" class="hidden">
    <div class="card">
        <h3 style="margin-bottom: 12px;">üõí –ú–æ–∏ –ø–æ–∫—É–ø–∫–∏</h3>
        <div id="buyerDealsList">
            <div class="text-center" style="padding: 20px; color: var(--tg-theme-hint-color);">
                ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–¥–µ–ª–æ–∫...
            </div>
        </div>
    </div>
</div>

<!-- –®–∞–±–ª–æ–Ω —Å–¥–µ–ª–∫–∏ -->
<template id="dealTemplate">
    <div class="deal-item">
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
            <div>
                <div class="deal-amount" data-field="amount"></div>
                <div class="deal-id" data-field="id"></div>
            </div>
            <div>
                <span class="status-badge" data-field="status"></span>
            </div>
        </div>
        
        <div style="font-size: 14px; color: var(--tg-theme-hint-color); margin-bottom: 8px;">
            <div data-field="description"></div>
            <div data-field="created_at"></div>
        </div>
        
        <div style="display: flex; gap: 8px;">
            <button class="btn" style="flex: 1; padding: 8px; font-size: 14px;" onclick="viewDeal(this)" data-field="view">
                üëÅÔ∏è –û—Ç–∫—Ä—ã—Ç—å
            </button>
            <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 14px;" onclick="shareDeal(this)" data-field="share">
                üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
            </button>
        </div>
    </div>
</template>

<!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
<template id="emptyTemplate">
    <div class="text-center" style="padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
        <h3 style="margin-bottom: 8px; color: var(--tg-theme-hint-color);">–ü–æ–∫–∞ –Ω–µ—Ç —Å–¥–µ–ª–æ–∫</h3>
        <p style="color: var(--tg-theme-hint-color); margin-bottom: 16px;">
            –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é —Å–¥–µ–ª–∫—É –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ NFT –ø–æ–¥–∞—Ä–∫–∞
        </p>
        <button class="btn" onclick="navigateTo('/create')">
            ‚ûï –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É
        </button>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
let currentTab = 'seller';
let sellerDeals = [];
let buyerDeals = [];

document.addEventListener('DOMContentLoaded', function() {
    loadDeals();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ Telegram
    if (window.telegramWebApp) {
        window.telegramWebApp.MainButton.setText('–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É');
        window.telegramWebApp.MainButton.onClick(() => {
            navigateTo('/create');
        });
        window.telegramWebApp.MainButton.show();
    }
});

function showTab(tab) {
    currentTab = tab;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
    const sellerTab = document.getElementById('sellerTab');
    const buyerTab = document.getElementById('buyerTab');
    
    if (tab === 'seller') {
        sellerTab.className = 'btn';
        buyerTab.className = 'btn btn-secondary';
        document.getElementById('sellerDeals').classList.remove('hidden');
        document.getElementById('buyerDeals').classList.add('hidden');
    } else {
        sellerTab.className = 'btn btn-secondary';
        buyerTab.className = 'btn';
        document.getElementById('sellerDeals').classList.add('hidden');
        document.getElementById('buyerDeals').classList.remove('hidden');
    }
}

function loadDeals() {
    if (!window.telegramUser) {
        showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
    }
    
    fetch(`/api/my_deals?user_id=${window.telegramUser.id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sellerDeals = data.seller_deals || [];
                buyerDeals = data.buyer_deals || [];
                renderDeals();
            } else {
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–æ–∫');
            }
        })
        .catch(error => {
            showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
}

function renderDeals() {
    renderDealsList('sellerDealsList', sellerDeals, 'seller');
    renderDealsList('buyerDealsList', buyerDeals, 'buyer');
}

function renderDealsList(containerId, deals, type) {
    const container = document.getElementById(containerId);
    
    if (deals.length === 0) {
        const emptyTemplate = document.getElementById('emptyTemplate');
        container.innerHTML = emptyTemplate.innerHTML;
        return;
    }
    
    container.innerHTML = '';
    
    deals.forEach(deal => {
        const dealElement = createDealElement(deal, type);
        container.appendChild(dealElement);
    });
}

function createDealElement(deal, type) {
    const template = document.getElementById('dealTemplate');
    const element = template.content.cloneNode(true);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    const amountEl = element.querySelector('[data-field="amount"]');
    const idEl = element.querySelector('[data-field="id"]');
    const statusEl = element.querySelector('[data-field="status"]');
    const descriptionEl = element.querySelector('[data-field="description"]');
    const createdAtEl = element.querySelector('[data-field="created_at"]');
    const viewBtn = element.querySelector('[data-field="view"]');
    const shareBtn = element.querySelector('[data-field="share"]');
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—É–º–º—É
    const currencySymbols = {
        'stars': '‚≠ê',
        'rub': '‚ÇΩ',
        'uah': '‚Ç¥',
        'usd': '$',
        'eur': '‚Ç¨'
    };
    
    amountEl.textContent = `${currencySymbols[deal[6]] || ''} ${deal[5]}`;
    idEl.textContent = `ID: ${deal[0]}`;
    
    // –°—Ç–∞—Ç—É—Å
    const statusText = {
        'pending': '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã',
        'paid': '–û–ø–ª–∞—á–µ–Ω–æ',
        'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
        'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
    };
    
    statusEl.textContent = statusText[deal[7]] || deal[7];
    statusEl.className = `status-badge status-${deal[7]}`;
    
    // –û–ø–∏—Å–∞–Ω–∏–µ
    descriptionEl.textContent = deal[11] || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è';
    
    // –î–∞—Ç–∞
    const date = new Date(deal[8]);
    createdAtEl.textContent = date.toLocaleDateString('ru-RU');
    
    // –ö–Ω–æ–ø–∫–∏
    viewBtn.setAttribute('data-deal-id', deal[0]);
    shareBtn.setAttribute('data-deal-id', deal[0]);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –¥–ª—è –ø–æ–∫—É–ø–æ–∫
    if (type === 'buyer') {
        shareBtn.style.display = 'none';
        viewBtn.style.flex = '1';
    }
    
    return element;
}

function viewDeal(button) {
    const dealId = button.getAttribute('data-deal-id');
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–¥–µ–ª–∫–∏
    showAlert(`–û—Ç–∫—Ä—ã—Ç–∏–µ —Å–¥–µ–ª–∫–∏ ${dealId}`);
}

function shareDeal(button) {
    const dealId = button.getAttribute('data-deal-id');
    const dealUrl = `https://t.me/noscamnftrbot/app?startapp=deal_${dealId}`;
    const text = `üéÅ –ü—Ä–∏–≤–µ—Ç! –Ø —Å–æ–∑–¥–∞–ª —Å–¥–µ–ª–∫—É –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ NFT –ø–æ–¥–∞—Ä–∫–∞. –ú–æ–∂–µ—à—å –±–µ–∑–æ–ø–∞—Å–Ω–æ –∫—É–ø–∏—Ç—å –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ: ${dealUrl}`;
    shareLink(dealUrl, text);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(loadDeals, 30000);
</script>
{% endblock %}