{% extends "mini_app/base.html" %}

{% block title %}–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É - NFT Gifts Market{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 16px;">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É</h2>
    
    <form id="createDealForm">
        <div class="form-group">
            <label class="form-label">üéÅ –°—Å—ã–ª–∫–∞ –Ω–∞ NFT –ø–æ–¥–∞—Ä–æ–∫</label>
            <input type="url" class="form-control" id="nftLink" 
                   placeholder="https://t.me/gift/..." required>
            <small style="color: var(--tg-theme-hint-color); font-size: 12px;">
                –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ NFT –ø–æ–¥–∞—Ä–æ–∫ –≤ Telegram
            </small>
        </div>
        
        <div class="form-group">
            <label class="form-label">üë§ Username –ø–æ–ª—É—á–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input type="text" class="form-control" id="nftUsername" 
                   placeholder="@username">
            <small style="color: var(--tg-theme-hint-color); font-size: 12px;">
                –ï—Å–ª–∏ NFT –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            </small>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
                <label class="form-label">üí∞ –°—É–º–º–∞</label>
                <input type="number" class="form-control" id="amount" 
                       step="0.01" min="0.01" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">üí± –í–∞–ª—é—Ç–∞</label>
                <select class="form-select" id="currency" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                    <option value="stars">‚≠ê –ó–≤–µ–∑–¥—ã</option>
                    <option value="rub">‚ÇΩ –†—É–±–ª–∏</option>
                    <option value="uah">‚Ç¥ –ì—Ä–∏–≤–Ω—ã</option>
                    <option value="usd">$ –î–æ–ª–ª–∞—Ä—ã</option>
                    <option value="eur">‚Ç¨ –ï–≤—Ä–æ</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">üìù –û–ø–∏—Å–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏</label>
            <textarea class="form-control" id="description" rows="3" 
                      placeholder="–û–ø–∏—à–∏—Ç–µ NFT –ø–æ–¥–∞—Ä–æ–∫, —É—Å–ª–æ–≤–∏—è —Å–¥–µ–ª–∫–∏..."></textarea>
        </div>
        
        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è –í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong><br>
            ‚Ä¢ –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Å—Å—ã–ª–∫—É –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è<br>
            ‚Ä¢ –°—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ—Å—Ç—É–ø—è—Ç –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º<br>
            ‚Ä¢ –ü–µ—Ä–µ–≤–æ–¥–∏—Ç–µ NFT —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã
        </div>
        
        <button type="submit" class="btn" id="createBtn">
            ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É
        </button>
        
        <button type="button" class="btn btn-secondary" onclick="navigateTo('/')">
            ‚ùå –û—Ç–º–µ–Ω–∞
        </button>
    </form>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è -->
<div id="successModal" class="hidden">
    <div class="card" style="background: #d4edda; border: 1px solid #c3e6cb;">
        <h3 style="color: #155724; margin-bottom: 16px;">üéâ –°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!</h3>
        
        <div style="margin: 16px 0;">
            <strong>ID —Å–¥–µ–ª–∫–∏:</strong> <span id="dealId"></span>
        </div>
        
        <div style="margin: 16px 0;">
            <label class="form-label">üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:</label>
            <div style="display: flex; gap: 8px;">
                <input type="text" class="form-control" id="dealUrl" readonly>
                <button class="btn" style="width: auto; padding: 12px;" onclick="copyDealUrl()">
                    üìã
                </button>
            </div>
        </div>
        
        <button class="btn btn-success" onclick="shareDeal()">
            üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π
        </button>
        
        <button class="btn btn-secondary" onclick="navigateTo('/deals')">
            üìã –ú–æ–∏ —Å–¥–µ–ª–∫–∏
        </button>
        
        <button class="btn btn-secondary" onclick="createAnother()">
            ‚ûï –°–æ–∑–¥–∞—Ç—å –µ—â–µ –æ–¥–Ω—É
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('createDealForm');
    const createBtn = document.getElementById('createBtn');
    const successModal = document.getElementById('successModal');
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ Telegram
    if (window.telegramWebApp) {
        window.telegramWebApp.MainButton.setText('–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É');
        window.telegramWebApp.MainButton.onClick(submitForm);
        window.telegramWebApp.MainButton.show();
    }
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm();
    });
    
    function submitForm() {
        if (!window.telegramUser) {
            showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            return;
        }
        
        const formData = {
            nft_link: document.getElementById('nftLink').value,
            nft_username: document.getElementById('nftUsername').value,
            amount: parseFloat(document.getElementById('amount').value),
            currency: document.getElementById('currency').value,
            description: document.getElementById('description').value,
            telegram_user: window.telegramUser
        };
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!formData.nft_link || !formData.amount || !formData.currency) {
            showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        createBtn.classList.add('loading');
        createBtn.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        fetch('/api/create_deal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            createBtn.classList.remove('loading');
            createBtn.textContent = '‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É';
            
            if (data.success) {
                showSuccess(data.deal_id, data.deal_url);
            } else {
                showAlert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        })
        .catch(error => {
            createBtn.classList.remove('loading');
            createBtn.textContent = '‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É';
            showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
    }
    
    function showSuccess(dealId, dealUrl) {
        document.getElementById('dealId').textContent = dealId;
        document.getElementById('dealUrl').value = dealUrl;
        
        form.style.display = 'none';
        successModal.classList.remove('hidden');
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        if (window.telegramWebApp) {
            window.telegramWebApp.MainButton.hide();
        }
    }
    
    window.copyDealUrl = function() {
        const urlInput = document.getElementById('dealUrl');
        copyToClipboard(urlInput.value);
    };
    
    window.shareDeal = function() {
        const dealUrl = document.getElementById('dealUrl').value;
        const text = `üéÅ –ü—Ä–∏–≤–µ—Ç! –Ø —Å–æ–∑–¥–∞–ª —Å–¥–µ–ª–∫—É –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ NFT –ø–æ–¥–∞—Ä–∫–∞. –ú–æ–∂–µ—à—å –±–µ–∑–æ–ø–∞—Å–Ω–æ –∫—É–ø–∏—Ç—å –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ: ${dealUrl}`;
        shareLink(dealUrl, text);
    };
    
    window.createAnother = function() {
        form.style.display = 'block';
        successModal.classList.add('hidden');
        form.reset();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        if (window.telegramWebApp) {
            window.telegramWebApp.MainButton.show();
        }
    };
});
</script>
{% endblock %}