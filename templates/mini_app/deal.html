{% extends "mini_app/base.html" %}

{% block title %}–°–¥–µ–ª–∫–∞ #{{ deal_id }} - NFT Gifts Market{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 16px;">üéÅ –°–¥–µ–ª–∫–∞ #{{ deal_id }}</h2>
    <div id="dealInfo">
        <div class="text-center" style="padding: 20px; color: var(--tg-theme-hint-color);">
            ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–¥–µ–ª–∫–µ...
        </div>
    </div>
</div>

<div class="card">
    <h3 style="margin-bottom: 12px;">üí° –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
    <p style="font-size: 14px; color: var(--tg-theme-hint-color);">
        –≠—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–¥–µ–ª–∫–∏. –ó–¥–µ—Å—å –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–ø–ª–∞—Ç–∏—Ç—å NFT –ø–æ–¥–∞—Ä–æ–∫, –∞ –ø—Ä–æ–¥–∞–≤–µ—Ü - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É.
    </p>
</div>

<!-- –®–∞–±–ª–æ–Ω –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–¥–µ–ª–∫–µ -->
<template id="dealInfoTemplate">
    <div style="margin-bottom: 16px;">
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 12px;">
            <div>
                <div class="deal-amount" data-field="amount"></div>
                <div style="font-size: 12px; color: var(--tg-theme-hint-color);" data-field="created_at"></div>
            </div>
            <div>
                <span class="status-badge" data-field="status"></span>
            </div>
        </div>
        
        <div style="margin: 12px 0;">
            <strong>NFT –ø–æ–¥–∞—Ä–æ–∫:</strong>
            <div data-field="nft_info"></div>
        </div>
        
        <div style="margin: 12px 0;" data-field="description_block">
            <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
            <div data-field="description"></div>
        </div>
        
        <div style="margin: 16px 0;">
            <strong>–ü—Ä–æ–¥–∞–≤–µ—Ü:</strong> <span data-field="seller_id"></span>
        </div>
    </div>
    
    <div data-field="actions">
        <!-- –î–µ–π—Å—Ç–≤–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
</template>

<!-- –®–∞–±–ª–æ–Ω –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è -->
<template id="buyerActionsTemplate">
    <div class="alert alert-info">
        <strong>üí∞ –î–ª—è –ø–æ–∫—É–ø–∫–∏:</strong><br>
        –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞, –∑–∞—Ç–µ–º –æ–ø–ª–∞—Ç–∏—Ç–µ —Å–¥–µ–ª–∫—É.
    </div>
    <button class="btn" onclick="payDeal()">
        üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Å–¥–µ–ª–∫—É
    </button>
</template>

<!-- –®–∞–±–ª–æ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞ -->
<template id="sellerActionsTemplate">
    <div class="alert alert-success">
        <strong>‚úÖ –°–¥–µ–ª–∫–∞ –æ–ø–ª–∞—á–µ–Ω–∞!</strong><br>
        –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ NFT –ø–æ–¥–∞—Ä–æ–∫ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
    </div>
    <button class="btn" onclick="completeDeal()">
        üéÅ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É NFT
    </button>
</template>

<!-- –®–∞–±–ª–æ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π —Å–¥–µ–ª–∫–∏ -->
<template id="completedTemplate">
    <div class="alert alert-success">
        <strong>üéâ –°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</strong><br>
        NFT –ø–æ–¥–∞—Ä–æ–∫ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω. –°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—à–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã!
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
let currentDeal = null;

document.addEventListener('DOMContentLoaded', function() {
    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    console.log('=== –û–¢–õ–ê–î–ö–ê –ü–ê–†–ê–ú–ï–¢–†–û–í –°–î–ï–õ–ö–ò ===');
    console.log('URL:', window.location.href);
    console.log('Deal ID –∏–∑ URL:', '{{ deal_id }}');
    
    if (window.telegramWebApp) {
        console.log('Telegram WebApp initData:', window.telegramWebApp.initDataUnsafe);
        console.log('Start param:', window.telegramWebApp.initDataUnsafe?.start_param);
    }
    
    loadDealInfo();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ Telegram
    if (window.telegramWebApp) {
        window.telegramWebApp.MainButton.hide();
    }
});

function loadDealInfo() {
    const dealId = '{{ deal_id }}';
    
    fetch(`/api/deal/${dealId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentDeal = data.deal;
                renderDealInfo(data.deal);
            } else {
                showError('–°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            }
        })
        .catch(error => {
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
        });
}

function renderDealInfo(deal) {
    const container = document.getElementById('dealInfo');
    const template = document.getElementById('dealInfoTemplate');
    const element = template.content.cloneNode(true);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    const currencySymbols = {
        'stars': '‚≠ê',
        'rub': '‚ÇΩ',
        'uah': '‚Ç¥',
        'usd': '$',$',
        'eur': '‚Ç¨'
    };
    
    element.querySelector('[data-field="amount"]').textContent = 
        `${currencySymbols[deal.currency] || ''} ${deal.amount}`;
    
    element.querySelector('[data-field="created_at"]').textContent = 
        `–°–æ–∑–¥–∞–Ω–æ: ${new Date(deal.created_at).toLocaleDateString('ru-RU')}`;
    
    // –°—Ç–∞—Ç—É—Å
    const statusText = {
        'pending': '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã',
        'paid': '–û–ø–ª–∞—á–µ–Ω–æ',
        'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
        'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
    };
    
    const statusEl = element.querySelector('[data-field="status"]');
    statusEl.textContent = statusText[deal.status] || deal.status;
    statusEl.className = `status-badge status-${deal.status}`;
    
    // NFT –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    const nftInfo = element.querySelector('[data-field="nft_info"]');
    if (deal.nft_link) {
        nftInfo.innerHTML = `<a href="${deal.nft_link}" target="_blank" style="color: var(--tg-theme-link-color);">–û—Ç–∫—Ä—ã—Ç—å NFT –ø–æ–¥–∞—Ä–æ–∫</a>`;
    } else if (deal.nft_username) {
        nftInfo.textContent = `–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${deal.nft_username}`;
    } else {
        nftInfo.textContent = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
    }
    
    // –û–ø–∏—Å–∞–Ω–∏–µ
    if (deal.description) {
        element.querySelector('[data-field="description"]').textContent = deal.description;
    } else {
        element.querySelector('[data-field="description_block"]').style.display = 'none';
    }
    
    // –ü—Ä–æ–¥–∞–≤–µ—Ü
    element.querySelector('[data-field="seller_id"]').textContent = deal.seller_id;
    
    // –î–µ–π—Å—Ç–≤–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const actionsContainer = element.querySelector('[data-field="actions"]');
    renderActions(actionsContainer, deal);
    
    container.innerHTML = '';
    container.appendChild(element);
}

function renderActions(container, deal) {
    if (deal.status === 'completed') {
        const template = document.getElementById('completedTemplate');
        container.appendChild(template.content.cloneNode(true));
    } else if (deal.status === 'pending') {
        const template = document.getElementById('buyerActionsTemplate');
        container.appendChild(template.content.cloneNode(true));
    } else if (deal.status === 'paid') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞
        if (window.telegramUser && window.telegramUser.id == deal.seller_id) {
            const template = document.getElementById('sellerActionsTemplate');
            container.appendChild(template.content.cloneNode(true));
        } else {
            container.innerHTML = '<div class="alert alert-info"><strong>‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü–∞</strong><br>–°–¥–µ–ª–∫–∞ –æ–ø–ª–∞—á–µ–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏—è NFT –ø–æ–¥–∞—Ä–∫–∞.</div>';
        }
    }
}

function payDeal() {
    if (!window.telegramUser) {
        showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
    }
    
    confirmAction('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å —ç—Ç—É —Å–¥–µ–ª–∫—É?', (confirmed) => {
        if (confirmed) {
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –æ–ø–ª–∞—Ç—ã
            showAlert('–§—É–Ω–∫—Ü–∏—è –æ–ø–ª–∞—Ç—ã –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π');
        }
    });
}

function completeDeal() {
    confirmAction('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –≤—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ NFT –ø–æ–¥–∞—Ä–æ–∫ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é', (confirmed) => {
        if (confirmed) {
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏
            showAlert('–§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
        }
    });
}

function showError(message) {
    document.getElementById('dealInfo').innerHTML = `
        <div class="text-center" style="padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
            <h3 style="margin-bottom: 8px; color: var(--tg-theme-hint-color);">–û—à–∏–±–∫–∞</h3>
            <p style="color: var(--tg-theme-hint-color);">${message}</p>
            <button class="btn" onclick="navigateTo('/')">
                üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é
            </button>
        </div>
    `;
}
</script>
{% endblock %}